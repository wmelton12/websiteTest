<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title> world test </title>
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
		<script src="http://joyrexus.spc.uchicago.edu/resources/coffee-script.js"></script>

	</head>
	<body>
<script type="text/coffeescript">
class Vector
	constructor: (@x,@y) ->
	getY: ()-> return @y
	getX: ()-> return @x
	add: (v) ->
		nx = @x + v.x
		ny = @y + v.y
		return new Vector(nx,ny)
	sub: (v) ->
		nx = @x - v.x
		ny = @y - v.y
		return new Vector(nx, ny)
	clone: () ->
		nx = @x
		ny = @y
		return new Vector(@x, @y)
	mult: (m) ->
		nx = @x * m
		ny = @y * m
		return new Vector(nx, ny)
	div: (m) ->
		return this.mult(1 / m)
	mag: () ->
		return Math.sqrt(@x*@x + @y*@y)
	roundMag: () ->
		nx = Math.round(@x)
		ny = Math.round(@y)
		return Math.round(Math.sqrt(nx*nx + ny*ny))
	heading: () ->
		return Math.atan2(@y,@x)
	setMag: (m) ->
		return this.normalize().mult(m)
	limit: (l) ->
		if(this.mag() < l) 
			return this.clone()
		else 	
			return this.setMag(l)
	normalize: () ->
		m = this.mag()
		if(m != 0)
			nx = @x/m
			ny = @y/m
			return new Vector(nx, ny)
		else 
			return this.clone()
	toString: () ->
		return "x: " + @x + ", y: " + @y

class Collider
    constructor: ()->
    	@x1 = 0
    	@x2 = 0
   	circleAndHorizontalLine: (c, l) ->
   		@x1 = l.attr('x1')
   		@x2 = l.attr('x2')
   		y = l.attr('y1')
   		if y != l.attr('y2')
   			alert('invalid line')
   		
   		cx = parseInt(c.attr('cx'))
   		cy = parseInt(c.attr('cy'))
   		r = parseInt(c.attr('r'))
   		top = cy - r
   		bottom = cy + r
   		#alert("bottom: " + bottom + " cy: " + cy + " r: " + r)
   		leftMargin = cx - r
   		rightMargin = cx + r
   		
   		#alert("x1:"+@x1+"x2:"+@x2)
   		if leftMargin < @x2 && rightMargin > @x1
   			if top < y < bottom
   				#alert "collision detected! This has been changed"
   				#alert("top: " + top + " bottom: " + bottom + " r: " + r + " cy: " + cy)
   				return true
   			
    distance: (ax,ay,bx,yb) ->
        return Math.sqrt(Math.pow(bx - ax, 2) + Math.pow(yb - ay, 2))


class Mover
	constructor: (@svg, @x, @y, @g, @g2) -> 
		@circ = @svg.append('circle')
						.attr('cx', @x)
						.attr('cy', @y)
						.attr('r', 20)
						.attr("fill","red")
		@coll = new Collider()
		@obstacle = null
		@points = []
		@force = new Vector(0.0,0.0)
		@vel = new Vector(0.0,0.0)
		@aboveObs = false
		@its = 0
	display: () ->
			@points.push(@svg.append('circle')
				.attr('r',1)
				.attr('cx', @x)
				.attr('cy',@y)
				.attr('fill','orange'))
			@circ.attr("cx", @x)
				.attr("cy", @y)
			
			if(@points.length > 300)	
				@points[0].remove()
				@points.shift()
	setObstacle: (l) ->
		@obstacle = l
	applyForce: (v) ->
		@force = @force.add(new Vector(v.x, v.y*-1))
	resetForce: () ->
		@force = new Vector(0.0,0.0)
	update: () ->
		if(@obstacle != null)
			if(@its % 100 == 0)
				@aboveObs = @y < parseInt(@obstacle.attr('y1'))
		@vel = @vel.add(@force)
		@x += @vel.x
		@y += @vel.y
		nv = @vel.mult(20)
		nv = new Vector(nv.x, nv.y*-1)
		if @g != null then @g.drawSingleBar(nv.mag())
		if @g != null then @g2.drawVector(nv)
		@its++
	
	checkEdges: (w, h) ->
				
		if(@x+20 >= w)
			@x = w-20
			@vel.x*=-1
		else if(@x-20 <= 0)
			@x = 20
			@vel.x*=-1
		if(@y+20 >= h)
			@vel.y*=-1
			@y = h-20
		else if(@y-20 <= 0)
			@y = 20
			@vel.y*=-1
		if(@obstacle != null)
			if(@coll.circleAndHorizontalLine(@circ, @obstacle))	
				#console.log 'hello, there'
				@vel.y*=-1
				oy = parseInt(@obstacle.attr('y1'))
				if(@aboveObs)
					@y = oy - 20
					#alert(oy)
					#alert(@y)
					#alert(aboveObs)
				else
					@y = oy + 20
					#alert(oy)
					#alert(aboveObs)

class SystemController
	constructor: (@svg) ->
		@movers = []
		@forces = []
		@svg.append('rect')
			.attr('width', '100%')
			.attr('height', '100%')
			.attr('fill','none')
			.attr('stroke','black')
		@obs = null;
	addForce: (v) ->
		@forces[@forces.length] = v
		return @forces.length-1
	addMover: (x,y,g1,g2) ->
		@movers[@movers.length] = new Mover(@svg,x,y,g1,g2)
		@movers[@movers.length - 1].display()
		return @movers.length - 1
	update: ()->
		i = 0
		while(i<@movers.length)
			 @updateSingle(i)
			 i++
	changeForce: (i,v) ->
		@forces[i] = v
	addObstacle: () ->
		y = Math.floor(Math.random() * @svg.attr('height'))
		x1 = Math.floor(Math.random() * @svg.attr('width'))
		range = @svg.attr('width') - x1
		x2 = Math.floor(Math.random() * range) + x1
		y = 350
		x1 = 0
		x2 = 400
		@obs = @svg.append('line')
					.attr('x1',x1)
					.attr('y1',y)
					.attr('x2',x2)
					.attr('y2',y)
					.attr('stroke','black')
		
	updateSingle: (i) ->
		@movers[i].resetForce()
		j = 0
		while j < @forces.length
			@movers[i].applyForce(@forces[j])
			j++	
		@movers[i].update()	
		@movers[i].checkEdges(@svg.attr('width'), @svg.attr('height'))
		@movers[i].display()
		@movers[i].setObstacle(@obs)
		

          
		

w = 500
h = 500
svg = d3.select('body')
		.append('svg')
		.attr('width',w)
		.attr('height',h)
barGraph = d3.select('body')
			.append('svg')
			.attr('width', 200)
			.attr('height', 200)
			.attr('x', 510)
			.attr('y', 0)
g = new Grapher(barGraph)
world = new SystemController(svg)
world.addMover(w/2,h/2,g,null)

world.addForce(new Vector(0.01,-0.02))
world.addObstacle()
setInterval( () ->
	world.update()
, 10)

</script>
	</body>
</html>
